{% extends 'base.html' %}

{% block content %}
<style>
    .centered-card {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .card-container {
    margin: 30px 0 !important;
    }

    .link-recorte {
        position: relative; /* Necesario para posicionar el ::before */
        color: #990a0a;
        text-decoration: none;
        transition: transform 0.3s ease-in-out; /* Mantén la transición para el scale si lo usas */
    }

    .link-recorte::before {
        content: '';
        position: absolute;
        bottom: 0; /* Posición en la parte inferior */
        left: 0;
        width: 0; /* Inicialmente sin ancho */
        height: 1px; /* Grosor de la línea */
        background-color: #990a0a;
        transition: width 0.3s ease-in-out; /* Transición para el ancho */
    }

    .link-recorte:hover::before {
        width: 100%; /* La línea se expande al 100% del ancho del enlace */
    }


</style>
<div class="centered-card">
    <div class="col-12 col-sm-10 col-md-8 col-lg-6 card-container">
        <div class="card shadow-lg rounded border-0">
            <div class="card-header bg-dark text-white text-center">
                <h5 class="mb-0">Editar Paquete</h5>
            </div>
            <div class="card-body p-4">
                <form method="post" enctype="multipart/form-data" data-ajax="true">
                    <div class="mb-3">
                        <label for="Descripcion" class="form-label">Descripción</label>
                        <input type="text" name="Descripcion" id="Descripcion" class="form-control" value="{{ paquete.Descripcion }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="TipoPaquete" class="form-label">Tipo de Paquete</label>
                        <select name="TipoPaquete" id="TipoPaquete" class="form-select" required>
                            <option value="6" {% if paquete.TipoPaquete == 6 or paquete.TipoPaquete == '6' %}selected{% endif %}>6 unidades</option>
                            <option value="8" {% if paquete.TipoPaquete == 8 or paquete.TipoPaquete == '8' %}selected{% endif %}>8 unidades</option>
                            <option value="12" {% if paquete.TipoPaquete == 12 or paquete.TipoPaquete == '12' %}selected{% endif %}>12 unidades</option>
                            <option value="24" {% if paquete.TipoPaquete == 24 or paquete.TipoPaquete == '24' %}selected{% endif %}>24 unidades</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="UnidadesSobrantes" class="form-label">Unidades Sobrantes</label>
                        <input type="number" step="1" name="UnidadesSobrantes" id="UnidadesSobrantes" class="form-control" value="{{ paquete.UnidadesSobrantes }}" min="0" max="24">
                        <div class="invalid-feedback" id="unidades-error"></div>
                    </div>
                    <div class="mb-3">
                        <label for="PaquetesCompletos" class="form-label">Paquetes Completos</label>
                        <input type="number" step="1" name="PaquetesCompletos" id="Inventario" class="form-control" value="{{ paquete.PaquetesCompletos }}">
                    </div>
                    <div class="mb-3">
                        <label for="PrecioVenta_Paq" class="form-label">Precio de Venta</label>
                        <input type="number" name="PrecioVenta_Paq" id="PrecioVenta_Paq" class="form-control" value="{{ paquete.PrecioVenta_Paq }}">
                    </div>
                    <div class="mb-3">
                        <label for="PrecioCompra_Paq" class="form-label">Precio de Compra</label>
                        <input type="number" step="0.01" name="PrecioCompra_Paq" id="PrecioCompra_Paq" class="form-control" value="{{ paquete.PrecioCompra_Paq }}">
                    </div>
                    <div class="mb-3">
                        <label for="imagen" class="form-label">Nueva Imagen del Producto (opcional)</label>
                        <input type="file" class="form-control" name="imagen" id="imagen" accept="image/*">
                        
                        <!-- Vista previa de la imagen actual -->
                        {% set nombre_archivo = paquete.Descripcion | sanitize ~ '.png' %}
                        {% set ruta_imagen = '/static/Paquetes/' ~ nombre_archivo %}
                        {% set ruta_por_defecto = '/static/Paquetes/PorDefecto.webp' %}
                        
                        {% if nombre_archivo in archivos_disponibles %}
                        <div class="mt-3">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Imagen Actual</h6>
                                </div>
                                <div class="card-body text-center">
                                    <img src="{{ ruta_imagen }}?t={{ timestamp }}" alt="Imagen actual" class="img-fluid" style="max-height: 200px; max-width: 100%; border-radius: 10px;">
                                    <div class="mt-2">
                                        <small>
                                            ¿Desea recortar la imagen?
                                            <a href="https://www.photoroom.com/es/herramientas/eliminador-de-fondos" target="_blank" class="link-recorte">
                                                Click aqui
                                            </a>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="mt-3">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Imagen Actual (Por Defecto)</h6>
                                </div>
                                <div class="card-body text-center">
                                    <img src="{{ ruta_por_defecto }}?t={{ timestamp }}" alt="Imagen por defecto" class="img-fluid" style="max-height: 200px; max-width: 100%;">
                                    <div class="mt-2">
                                        <small>
                                            ¿Desea recortar la imagen?
                                            <a href="https://www.photoroom.com/es/herramientas/eliminador-de-fondos" target="_blank" class="link-recorte">
                                                Click aqui
                                            </a>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Vista previa de la nueva imagen -->
                        <div id="preview-container" class="mt-3" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">Vista Previa de la Nueva Imagen</h6>
                                </div>
                                <div class="card-body text-center">
                                    <img id="image-preview" src="" alt="Vista previa" class="img-fluid" style="max-height: 200px; max-width: 100%;">
                                    <p id="image-info" class="mt-2 text-muted small"></p>
                                    <div class="mt-2">
                                        <small>
                                            ¿Desea recortar la imagen?
                                            <a href="https://www.photoroom.com/es/herramientas/eliminador-de-fondos" target="_blank" class="link-recorte">
                                                Click aqui
                                            </a>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-success">Guardar</button>
                        <a href="{{ url_for('ver_paquetes') }}" class="btn btn-outline-secondary">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Función de validación en tiempo real de unidades sobrantes
function initializeUnidadesValidation() {
    const tipoSelect = document.getElementById('TipoPaquete');
    const unidadesInput = document.getElementById('UnidadesSobrantes');
    const unidadesError = document.getElementById('unidades-error');
    const submitButton = document.querySelector('button[type="submit"]');

    // Si no existen los elementos, salir
    if (!tipoSelect || !unidadesInput || !unidadesError || !submitButton) {
        return;
    }

    function validateUnidades() {
        const tipoSeleccionado = parseInt(tipoSelect.value) || 0;
        const unidades = parseInt(unidadesInput.value) || 0;
        
        // Actualizar el atributo max del input
        unidadesInput.max = tipoSeleccionado;
        
        if (unidades > tipoSeleccionado) {
            // Actualizar el mensaje de error dinámicamente
            unidadesError.textContent = `No pueden sobrar ${unidades} unidades en un paquete de ${tipoSeleccionado} unidades`;
            unidadesInput.classList.add('is-invalid');
            submitButton.disabled = true;
            return false;
        } else {
            // Restaurar el mensaje original
            unidadesError.textContent = '';
            unidadesInput.classList.remove('is-invalid');
            submitButton.disabled = false;
            return true;
        }
    }

    // Remover event listeners anteriores para evitar duplicados
    tipoSelect.removeEventListener('change', validateUnidades);
    unidadesInput.removeEventListener('input', validateUnidades);
    
    // Agregar event listeners
    tipoSelect.addEventListener('change', validateUnidades);
    unidadesInput.addEventListener('input', validateUnidades);
    
    // Validar al enviar el formulario
    const form = document.querySelector('form');
    if (form) {
        // Remover event listener anterior
        form.removeEventListener('submit', formSubmitHandler);
        
        // Agregar nuevo event listener
        form.addEventListener('submit', formSubmitHandler);
    }
    
    // Validar al cargar la página
    validateUnidades();
}

// Handler para el submit del formulario
function formSubmitHandler(e) {
    const tipoSelect = document.getElementById('TipoPaquete');
    const unidadesInput = document.getElementById('UnidadesSobrantes');
    
    if (!tipoSelect || !unidadesInput) return;
    
    const tipoSeleccionado = parseInt(tipoSelect.value) || 0;
    const unidades = parseInt(unidadesInput.value) || 0;
    
    if (unidades > tipoSeleccionado) {
        e.preventDefault();
        alert('Por favor, corrige los errores antes de enviar el formulario.');
    }
}

// Inicializar en DOMContentLoaded (carga inicial)
document.addEventListener('DOMContentLoaded', initializeUnidadesValidation);

// Inicializar cuando se carga contenido via AJAX
document.addEventListener('contentLoaded', initializeUnidadesValidation);

// También inicializar inmediatamente si el DOM ya está listo
if (document.readyState === 'loading') {
    // El DOM aún se está cargando, esperar a DOMContentLoaded
} else {
    // El DOM ya está listo, inicializar inmediatamente
    initializeUnidadesValidation();
}
</script>

{% endblock %}
